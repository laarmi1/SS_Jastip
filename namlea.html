<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelacak Paket Namlea</title>
    <!-- Tailwind CSS CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk pemindai QR Code & Barcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="icon" href="icon.png" type="image/x-icon">
    <style>
        /* Menggunakan font Inter untuk tampilan yang bersih */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9F3ED; /* Warna Latar Utama */
        }
        /* Style untuk tabel agar lebih mudah dibaca */
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #f1f5f9; /* Slate 100 */
            font-weight: 600;
            color: #475569; /* Slate 600 */
        }
        tr:hover {
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Custom Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #FFFFFF;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px; /* Lebar maksimal untuk modal pelacakan */
            text-align: left; /* Sesuaikan teks ke kiri untuk detail */
        }
        /* Style khusus untuk modal pemindai */
        #scannerModal .modal-content {
            max-width: 500px;
        }
        #reader {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }
        .modal-button {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-button.confirm {
            background-color: #ef4444; /* Red-500 */
            color: white;
        }
        .modal-button.confirm:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .modal-button.cancel {
            background-color: #e5e7eb; /* Gray-200 */
            color: #374151; /* Gray-700 */
        }
        .modal-button.cancel:hover {
            background-color: #d1d5db; /* Gray-300 */
        }
        .modal-button.ok {
            background-color: #10455B; /* Warna Biru Tua */
            color: white;
        }
        .modal-button.ok:hover {
            opacity: 0.9;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
    <div class="max-w-6xl w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6" style="color: #10455B;">Paket Namlea</h1>

        <div class="mb-8 p-6 bg-slate-50 rounded-lg shadow-inner">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="resiNumbersInput" class="block text-sm font-medium text-gray-700 mb-1">Nomor Resi</label>
                    <textarea id="resiNumbersInput" rows="5" placeholder="Masukkan satu atau lebih nomor resi di sini, atau gunakan tombol 'Pindai'.&#10;Contoh:&#10;1234567890&#10;0987654321"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 shadow-sm" style="color: #10455B;"></textarea>
                    <button id="scanBarcodeBtn" class="w-full mt-2 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition duration-200" style="background-color: #10455B; color: #FFFFFF;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect>
                        </svg>
                        Pindai Resi
                    </button>
                </div>
                <div>
                    <label for="expeditionSelect" class="block text-sm font-medium text-gray-700 mb-1">Ekspedisi</label>
                    <select id="expeditionSelect"
                            class="w-full p-3 border rounded-lg shadow-sm font-bold" style="border-color: #FFAF20; background-color: #FFFFFF; color: #10455B;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <button id="trackPackageBtn"
                    class="w-full text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105" style="background-color: #FFAF20;">
                <span id="trackButtonText">Lacak Paket</span>
                <span id="loadingSpinner" class="loading-spinner hidden"></span>
            </button>
        </div>

        <div class="mb-8 p-6 bg-slate-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4" style="color: #10455B;">Daftar Paket Tersimpan (Lokal)</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nomor Resi</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ekspedisi</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status Terakhir</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal Disimpan</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="packageList">
                        <!-- Data paket akan dimuat di sini oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="saveToSheetBtn"
                        class="text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105" style="background-color: #10455B;">
                    <span id="saveButtonText">Simpan Semua ke Google Sheet</span>
                    <span id="saveLoadingSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts and Confirmations -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg text-gray-800"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- Buttons will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal for Tracking Results -->
    <div id="trackResultModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Detail Pelacakan Paket</h3>
            <div id="trackResultContent"></div>
            <div id="trackResultModalButtons" class="modal-buttons">
                <button class="modal-button ok" onclick="closeModal('trackResultModal')">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal for Barcode Scanner -->
    <div id="scannerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Pindai Barcode/QR Code</h3>
            <div id="reader" class="w-full"></div>
            <div class="modal-buttons">
                <button id="closeScannerBtn" class="modal-button cancel">Tutup Pemindai</button>
            </div>
        </div>
    </div>

    <!-- PERUBAHAN BARU: Tombol Kembali mengarah ke index.html -->
    <button onclick="window.location.href='index.html'" class="fixed bottom-5 right-5 text-white font-bold py-3 px-5 rounded-full shadow-lg z-50 transition duration-300 ease-in-out transform hover:scale-110" style="background-color: #10455B;">
        Kembali
    </button>

    <script>
        const resiNumbersInput = document.getElementById('resiNumbersInput');
        const expeditionSelect = document.getElementById('expeditionSelect');
        const trackPackageBtn = document.getElementById('trackPackageBtn');
        const trackButtonText = document.getElementById('trackButtonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const packageListTable = document.getElementById('packageList');
        const saveToSheetBtn = document.getElementById('saveToSheetBtn');
        const saveButtonText = document.getElementById('saveButtonText');
        const saveLoadingSpinner = document.getElementById('saveLoadingSpinner');
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');
        const trackResultModal = document.getElementById('trackResultModal');
        const trackResultContent = document.getElementById('trackResultContent');
        const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
        const scannerModal = document.getElementById('scannerModal');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        let html5QrcodeScanner;

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwV14l7OIhaF_xwglcZTd2gGNWUXHGBgjvcXbHb5F2z6k4BMqxPaqeBcNGmg8SGcN2Oeg/exec'; 
        const BINDERBYTE_API_KEY = '71218df7d6b8798f1d838aa69207d990244342e35cb21944a5db844cd8fb0c44';
        const BINDERBYTE_API_URL = 'https://api.binderbyte.com/v1/track';

        let packages = [];

        async function populateExpeditionSelect() {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Memuat daftar ekspedisi...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            expeditionSelect.appendChild(defaultOption);

            try {
                const response = await fetch(`https://api.binderbyte.com/v1/list_courier?api_key=${BINDERBYTE_API_KEY}`);
                const couriers = await response.json();

                expeditionSelect.innerHTML = ''; // Hapus opsi 'memuat'
                const firstOption = document.createElement('option');
                firstOption.value = '';
                firstOption.textContent = 'Pilih Ekspedisi';
                firstOption.disabled = true;
                firstOption.selected = true;
                expeditionSelect.appendChild(firstOption);

                couriers.forEach(courier => {
                    const option = document.createElement('option');
                    option.value = courier.code;
                    option.textContent = courier.description;
                    expeditionSelect.appendChild(option);
                });

            } catch (error) {
                console.error("Gagal memuat daftar ekspedisi:", error);
                expeditionSelect.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Gagal memuat daftar';
                errorOption.disabled = true;
                errorOption.selected = true;
                expeditionSelect.appendChild(errorOption);
                showAlert("Tidak dapat memuat daftar ekspedisi. Periksa koneksi internet Anda.");
            }
        }

        function showAlert(message) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button class="modal-button ok" onclick="closeModal('customModal')">OK</button>`;
            customModal.style.display = 'flex';
        }

        function showConfirm(message, onConfirm) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button class="modal-button confirm" onclick="handleConfirm(true)">Ya</button><button class="modal-button cancel" onclick="handleConfirm(false)">Batal</button>`;
            customModal.style.display = 'flex';
            window.confirmCallback = onConfirm;
        }

        function handleConfirm(isConfirmed) {
            closeModal('customModal');
            if (window.confirmCallback) {
                window.confirmCallback(isConfirmed);
                window.confirmCallback = null;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function loadPackages() {
            const storedPackages = localStorage.getItem('packages');
            if (storedPackages) packages = JSON.parse(storedPackages);
            renderPackageList();
        }

        function savePackages() {
            localStorage.setItem('packages', JSON.stringify(packages));
        }
        
        async function saveAllPackagesToSheets(allPackages) {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('PASTE_URL')) {
                console.error('URL Google Apps Script belum diatur!');
                return false;
            }
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(allPackages) 
                });
                return true;
            } catch (error) {
                console.error(`Gagal mengirim data paket ke Google Sheet:`, error);
                return false;
            }
        }

        function renderPackageList() {
            packageListTable.innerHTML = '';
            if (packages.length === 0) {
                packageListTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada paket yang disimpan secara lokal.</td></tr>`;
                saveToSheetBtn.disabled = true;
                saveToSheetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            saveToSheetBtn.disabled = false;
            saveToSheetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            packages.slice().reverse().forEach((pkg, index) => {
                const originalIndex = packages.length - 1 - index;
                const row = packageListTable.insertRow();
                row.innerHTML = `<td class="py-3 px-4">${pkg.awb || '-'}</td><td class="py-3 px-4">${pkg.courier || '-'}</td><td class="py-3 px-4"><span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${pkg.status === 'DELIVERED' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${pkg.status || '-'}</span></td><td class="py-3 px-4">${pkg.dateAddedToApp}</td><td class="py-3 px-4"><button data-awb="${pkg.awb}" data-courier="${pkg.courierCode || ''}" class="view-detail-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm mr-2">Detail</button><button data-index="${originalIndex}" class="delete-btn text-red-600 hover:text-red-800 font-medium">Hapus</button></td>`;
            });
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e => deletePackage(e.target.dataset.index)));
            document.querySelectorAll('.view-detail-btn').forEach(b => b.addEventListener('click', e => fetchAndDisplayTrackingDetails(e.target.dataset.awb, e.target.dataset.courier)));
        }

        function deletePackage(index) {
            showConfirm('Apakah Anda yakin ingin menghapus paket ini dari daftar lokal?', confirmed => {
                if (confirmed) {
                    packages.splice(index, 1);
                    savePackages();
                    renderPackageList();
                }
            });
        }

        trackPackageBtn.addEventListener('click', async () => {
            const rawResiNumbers = resiNumbersInput.value.trim();
            const expeditionCode = expeditionSelect.value;
            if (!rawResiNumbers || !expeditionCode) return showAlert('Nomor Resi dan Ekspedisi harus diisi!');
            const resiNumbers = rawResiNumbers.split(/[\n,]+/).map(r => r.trim()).filter(r => r);
            if (resiNumbers.length === 0) return showAlert('Tidak ada nomor resi yang valid.');
            trackButtonText.textContent = 'Melacak...';
            loadingSpinner.classList.remove('hidden');
            trackPackageBtn.disabled = true;
            let successCount = 0, failCount = 0;
            const trackingPromises = resiNumbers.map(async awb => {
                try {
                    const response = await fetch(`${BINDERBYTE_API_URL}?api_key=${BINDERBYTE_API_KEY}&courier=${expeditionCode}&awb=${awb}`);
                    const result = await response.json();
                    if (result.status === 200 && result.data) {
                        const lastHistory = result.data.history && result.data.history.length > 0 ? result.data.history[0] : { desc: '-' };
                        const lastDesc = lastHistory.desc.trim() || '';
                        
                        let receiverName = result.data.detail.receiver || '';
                        if (expeditionCode === 'spx' && !receiverName && lastDesc.includes('[') && lastDesc.includes(']')) {
                            const parts = lastDesc.split('[');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1];
                                receiverName = lastPart.split(']')[0].trim();
                            }
                        }
                        
                        packages.push({ 
                            awb: result.data.summary.awb || awb, 
                            courier: result.data.summary.courier || expeditionSelect.options[expeditionSelect.selectedIndex].text, 
                            courierCode: expeditionCode, 
                            service: result.data.summary.service || '-', 
                            status: result.data.summary.status || '-', 
                            date: result.data.summary.date || '-', 
                            origin: result.data.detail.origin || '-', 
                            destination: result.data.detail.destination || '-', 
                            shipper: result.data.detail.shipper || '-', 
                            receiver: receiverName || '-',
                            dateAddedToApp: new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })
                        });
                        successCount++;
                    } else { failCount++; }
                } catch (error) { failCount++; }
            });
            await Promise.allSettled(trackingPromises);
            savePackages();
            renderPackageList();
            trackButtonText.textContent = 'Lacak Paket';
            loadingSpinner.classList.add('hidden');
            trackPackageBtn.disabled = false;
            showAlert(`Pelacakan selesai: ${successCount} berhasil ditambahkan, ${failCount} gagal.`);
            resiNumbersInput.value = '';
        });

        saveToSheetBtn.addEventListener('click', async () => {
            if (packages.length === 0) return showAlert('Tidak ada data paket untuk disimpan.');
            showConfirm(`Anda akan menyimpan ${packages.length} data paket ke Google Sheet & membersihkan daftar lokal. Lanjutkan?`, async (confirmed) => {
                if (confirmed) {
                    saveButtonText.textContent = 'Menyimpan...';
                    saveLoadingSpinner.classList.remove('hidden');
                    saveToSheetBtn.disabled = true;
                    const success = await saveAllPackagesToSheets(packages);
                    if (success) {
                        showAlert(`Semua ${packages.length} data berhasil dikirim. Daftar lokal akan dikosongkan.`);
                        packages = [];
                        savePackages();
                        renderPackageList();
                    } else { 
                        showAlert('Gagal menyimpan data ke Google Sheet. Coba lagi.'); 
                    }
                    saveButtonText.textContent = 'Simpan Semua ke Google Sheet';
                    saveLoadingSpinner.classList.add('hidden');
                }
            });
        });

        async function fetchAndDisplayTrackingDetails(awb, courierCode) {
            if (!awb || !courierCode) return showAlert('Data ekspedisi tidak lengkap.');
            trackResultContent.innerHTML = `<p class="text-center text-gray-500">Memuat data untuk ${awb}...</p>`;
            trackResultModal.style.display = 'flex';
            try {
                const response = await fetch(`${BINDERBYTE_API_URL}?api_key=${BINDERBYTE_API_KEY}&courier=${courierCode}&awb=${awb}`);
                const result = await response.json();
                if (result.status === 200 && result.data) {
                    displayTrackingResultsModalContent(result.data, awb, courierCode);
                } else { trackResultContent.innerHTML = `<p class="text-red-600 text-center font-semibold">${result.message || 'Gagal melacak detail paket.'}</p>`; }
            } catch (error) { trackResultContent.innerHTML = `<p class="text-red-600 text-center font-semibold">Terjadi kesalahan jaringan.</p>`; }
        }

        function displayTrackingResultsModalContent(data, awb, courierName) {
            let historyHtml = data.history && data.history.length > 0 ? data.history.map(item => `<tr><td class="py-2 px-3 border-b">${item.date || '-'}</td><td class="py-2 px-3 border-b">${item.desc || '-'}</td><td class="py-2 px-3 border-b">${item.location || '-'}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center py-4">Tidak ada riwayat.</td></tr>`;
            trackResultContent.innerHTML = `<h4 class="text-xl font-bold mb-3">Ringkasan:</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6"><p><strong>Resi:</strong> ${data.summary.awb || awb}</p><p><strong>Ekspedisi:</strong> ${data.summary.courier || courierName}</p><p><strong>Layanan:</strong> ${data.summary.service || '-'}</p><p><strong>Status:</strong> <span class="font-semibold text-blue-600">${data.summary.status || '-'}</span></p><p><strong>Tanggal:</strong> ${data.summary.date || '-'}</p><p><strong>Pengirim:</strong> ${data.detail.shipper || '-'}</p><p><strong>Penerima:</strong> ${data.detail.receiver || '-'}</p><p><strong>Asal:</strong> ${data.detail.origin || '-'}</p><p><strong>Tujuan:</strong> ${data.detail.destination || '-'}</p></div><h4 class="text-xl font-bold mb-3">Riwayat:</h4><div class="border rounded-lg overflow-hidden"><table class="min-w-full bg-white text-sm"><thead><tr><th class="py-2 px-3 bg-gray-100 border-b text-left">Tanggal</th><th class="py-2 px-3 bg-gray-100 border-b text-left">Deskripsi</th><th class="py-2 px-3 bg-gray-100 border-b text-left">Lokasi</th></tr></thead><tbody>${historyHtml}</tbody></table></div>`;
        }

        const onScanSuccess = (decodedText, decodedResult) => {
            const currentValue = resiNumbersInput.value;
            if (currentValue.trim() === '') {
                resiNumbersInput.value = decodedText;
            } else {
                resiNumbersInput.value += '\n' + decodedText;
            }
            stopScannerAndCloseModal();
            showAlert(`Nomor Resi "${decodedText}" berhasil dipindai dan ditambahkan.`);
        };

        const onScanFailure = (error) => { /* Abaikan error */ };

        function stopScannerAndCloseModal() {
            if (html5QrcodeScanner && html5QrcodeScanner.getState() === 2) {
                html5QrcodeScanner.stop().catch(err => console.error("Gagal menghentikan pemindai.", err));
            }
            closeModal('scannerModal');
        }
        
        scanBarcodeBtn.addEventListener('click', () => {
            scannerModal.style.display = 'flex';
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, rememberLastUsedCamera: true, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA, Html5QrcodeScanType.SCAN_TYPE_FILE] };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure).catch(err => {
                showAlert("Tidak dapat memulai kamera. Pastikan Anda memberikan izin.");
                closeModal('scannerModal');
            });
        });

        closeScannerBtn.addEventListener('click', stopScannerAndCloseModal);

        document.addEventListener('DOMContentLoaded', () => {
            populateExpeditionSelect();
            loadPackages();
        });
    </script>
</body>
</html>
